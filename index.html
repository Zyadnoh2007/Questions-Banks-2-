<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>منصة الاختبارات | Zyad & Yusuf</title>

  <!-- =============================== -->
  <!--    جزء الـ CSS (الثيم الجديد)     -->
  <!-- =============================== -->
  <style>
    /* إضافة خط المرع لضمان دعم العربية */
    @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap');
    
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --card-bg: rgba(255, 255, 255, 0.98);
      --text-dark: #2d3748;
      --text-light: #718096;
      --shadow-light: 0 8px 25px rgba(0, 0, 0, 0.1);
      --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    body {
      box-sizing: border-box;
      /* إضافة خط المرع كأولوية */
      font-family: 'Almarai', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* --- Header --- */
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-heavy);
    }

    .header h1 {
      color: var(--text-dark);
      font-size: 2.5rem;
      margin: 0;
    }
     .header p {
      font-size: 1.1rem;
      color: var(--text-light);
    }


    /* --- Tab Navigation --- */
    .tab-container {
      display: flex;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 10px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-light);
    }

    .tab-btn {
      flex-grow: 1;
      text-align: center;
      padding: 15px 10px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      color: var(--text-light);
      border-radius: 10px;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .tab-btn.active {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* --- Tab Content (Quiz Selection) --- */
    .tab-content {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }

    .tab-content.active {
      display: grid;
    }

    .coming-soon {
      grid-column: 1 / -1;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text-dark);
      background: var(--card-bg);
      padding: 50px;
      border-radius: 15px;
    }

    /* --- Quiz Card --- */
    .quiz-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow-light);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 3px solid transparent;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      border-color: var(--primary-color);
    }

    .quiz-card h3 {
      color: var(--text-dark);
      font-size: 1.5rem;
      margin-bottom: 15px;
      text-align: center;
    }

    .quiz-card p {
      color: var(--text-light);
      text-align: center;
      margin-bottom: 20px;
      flex-grow: 1;
    }

    .start-btn {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      font-weight: bold;
      margin-top: 10px;
    }

    .start-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* --- Quiz Container --- */
    .quiz-container {
      display: none;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-heavy);
      margin-bottom: 30px;
      /* (تعديل) إضافة position relative ليتم وضع زر العودة بداخله */
      position: relative;
    }
    .quiz-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }

    .quiz-title {
      color: var(--text-dark);
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    #question-counter {
        color: var(--text-light);
    }

    .progress-bar {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    /* --- كارت السؤال (من الثيم الجديد) --- */
    .question-card {
      background: #f7fafc;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border-right: 5px solid var(--primary-color);
    }

    .question-number {
      color: var(--primary-color);
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 15px;
    }

    .question-text {
      font-size: 1.3rem;
      color: var(--text-dark);
      margin-bottom: 25px;
      line-height: 1.6;
      /* الأسئلة بالإنجليزية، لذا نجعلها من اليسار لليمين */
      text-align: left;
      direction: ltr;
    }

    .answer-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 600px;
      margin: 0 auto;
    }

    .answer-btn {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      /* الأسئلة بالإنجليزية، لذا نجعلها من اليسار لليمين */
      text-align: left;
      direction: ltr;
      width: 100%;
    }

    .answer-btn:hover {
      border-color: var(--primary-color);
    }
    
    .answer-btn.selected {
      background: #e9d8ff;
      border-color: var(--secondary-color);
      color: var(--text-dark);
    }
    
    /* أزرار الصح والخطأ */
    .tf-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        max-width: 400px;
        margin: 0 auto;
    }


    /* --- Quiz Navigation --- */
    .quiz-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .nav-btn {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
      min-width: 140px;
    }

    .nav-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }

    .back-btn {
      background: var(--text-light);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      /* هذا الكود يضع زر العودة في الأسفل */
      position: static; 
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
      text-align: center;
    }
    
    /* تعديل زر العودة داخل الاختبار ليصبح في الأعلى */
    .quiz-container .back-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        margin: 0;
        max-width: 150px;
        padding: 8px 15px;
        font-size: 0.9rem;
    }


    .back-btn:hover {
      background: var(--text-dark);
    }


    /* --- Results --- */
    .results {
      text-align: center;
      display: none;
    }

    .score {
      font-size: 3rem;
      color: var(--primary-color);
      font-weight: bold;
      margin: 20px 0;
    }

    /* --- Review Container --- */
    .review-container {
      display: none;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-heavy);
      margin-bottom: 30px;
      /* (تعديل) إضافة position relative ليتم وضع زر العودة بداخله */
      position: relative;
    }

    .review-question {
      background: #f7fafc;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border-right: 5px solid #e2e8f0;
    }
    
    .review-option {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      text-align: left;
      direction: ltr;
      width: 100%;
      margin-bottom: 10px;
      opacity: 0.7;
      /* (إضافة) منع التفاعل مع أزرار المراجعة */
      pointer-events: none;
    }

    .review-option.correct {
      background: #c6f6d5;
      border-color: #48bb78;
      opacity: 1;
    }

    .review-option.user-incorrect {
      background: #fed7d7;
      border-color: #f56565;
      text-decoration: line-through;
      opacity: 1;
    }

    /* --- Footer --- */
    .footer {
      text-align: center;
      margin-top: 50px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .footer p {
      color: #4a5568;
      font-size: 1.1rem;
      margin: 0;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .tab-container {
        flex-direction: column;
      }
      .tab-btn {
        width: 100%;
      }
      .tab-content {
        grid-template-columns: 1fr;
      }
      .quiz-container .back-btn {
        position: static;
        margin: 0 auto 20px auto;
      }
    }
  </style>

</head>
<body>

  <!-- =============================== -->
  <!--           جزء الـ HTML            -->
  <!-- =============================== -->
  <div class="container">
    <div class="header">
      <h1 id="site-title">منصة الاختبارات</h1>
      <p>اختبر معلوماتك في المواد الطبية</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <button class="tab-btn active" data-tab="microbiology">Microbiology Bank</button>
      <button class="tab-btn" data-tab="fundamental">Fundamental Bank</button>
      <button class="tab-btn" data-tab="biochemistry">Biochemistry Bank</button>
      <button class="tab-btn" data-tab="anatomy">Anatomy Bank</button>
      <button class="tab-btn" data-tab="physiology">Physiology Bank</button>
      <button class="tab-btn" data-tab="clinical">Clinical Bank</button>
    </div>

    <!-- Tab Content (Quiz Selection Area) -->
    <div id="quiz-selection">
      <div id="microbiology" class="tab-content active">
        <div class="quiz-card" data-bank="microbiology" data-quiz="morphology">
          <h3>Bacterial Morphology</h3>
          <p>19 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="microbiology" data-quiz="physiology">
          <h3>Bacterial Physiology</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="microbiology" data-quiz="flora">
          <h3>Normal Flora</h3>
          <p>18 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="microbiology" data-quiz="sterilization">
          <h3>Sterilization & Disinfection</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="microbiology" data-quiz="chemotherapy">
          <h3>Antimicrobial Chemotherapy</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="microbiology" data-quiz="general_tf">
          <h3>اختبار معلومات أساسية (صح وخطأ)</h3>
          <p>18 سؤال صح وخطأ</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
      </div>

      <!-- Other Tabs (Coming Soon) -->
      <div id="fundamental" class="tab-content">
        <p class="coming-soon">الأسئلة قادمة قريباً...</p>
      </div>
      <div id="biochemistry" class="tab-content">
        <p class="coming-soon">الأسئلة قادمة قريباً...</p>
      </div>
      <!-- Anatomy Tab -->
      <div id="anatomy" class="tab-content">
        <div class="quiz-card" data-bank="anatomy" data-quiz="respiratory">
          <h3>Respiratory System</h3>
          <p>11 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="anatomy" data-quiz="heart">
          <h3>The Heart</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="anatomy" data-quiz="general">
          <h3>General Anatomy</h3>
          <p>5 أسئلة اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
      </div>
      <!-- Physiology Tab -->
      <div id="physiology" class="tab-content">
        <div class="quiz-card" data-bank="physiology" data-quiz="cns">
          <h3>CNS (Central Nervous System)</h3>
          <p>15 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="physiology" data-quiz="blood">
          <h3>Blood</h3>
          <p>15 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <div class="quiz-card" data-bank="physiology" data-quiz="cvs">
          <h3>CVS (Cardiovascular System)</h3>
          <p>15 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
      </div>
      
      <!-- =========================================== -->
      <!-- (!!!) هذا هو الجزء الذي تم تعديله (!!!) -->
      <!-- =========================================== -->
      <div id="clinical" class="tab-content">
        <!-- Card 1 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_1">
          <h3>Hand Hygiene & PPE - Part 1</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 2 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_2">
          <h3>Hand Hygiene & PPE - Part 2</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 3 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_3">
          <h3>Hand Hygiene & PPE - Part 3</h3>
          <p>6 أسئلة اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 4 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_4">
          <h3>Patient Positioning - Part 1</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 5 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_5">
          <h3>Patient Positioning - Part 2</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 6 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_6">
          <h3>Patient Positioning - Part 3</h3>
          <p>6 أسئلة اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 7 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_7">
          <h3>Body Mechanics - Part 1</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 8 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_8">
          <h3>Body Mechanics - Part 2</h3>
          <p>20 سؤال اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
        <!-- Card 9 -->
        <div class="quiz-card" data-bank="clinical" data-quiz="clinical_9">
          <h3>Body Mechanics - Part 3</h3>
          <p>4 أسئلة اختيار من متعدد</p><button class="start-btn">ابدأ الاختبار</button>
        </div>
      </div>
      <!-- =========================================== -->
      <!--       نهاية الجزء الذي تم تعديله          -->
      <!-- =========================================== -->

    </div>

    <!-- Quiz Container -->
    <div id="quiz-container" class="quiz-container">
      <button class="back-btn go-back">← العودة للقائمة</button>
      <div class="quiz-header">
        <h2 id="current-quiz-title" class="quiz-title"></h2>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <p id="question-counter"></p>
      </div>
      <div id="question-container">
        <!-- Questions will be rendered here by JS -->
      </div>

      <div class="quiz-navigation">
        <button id="prev-btn" class="nav-btn" disabled>السابق</button>
        <button id="next-btn" class="nav-btn">التالي</button>
      </div>
    </div>

    <!-- Results Screen -->
    <div id="results" class="quiz-container results">
      <h3>انتهى الاختبار!</h3>
      <div id="final-score" class="score"></div>
      <p id="score-message"></p>
      <button id="review-btn" class="start-btn">مراجعة الإجابات</button>
      <button class="start-btn go-back">العودة للرئيسية</button>
    </div>

    <!-- Review Screen -->
    <div id="review-container" class="review-container">
      <h2 class="quiz-title">مراجعة الإجابات</h2>
      <!-- (تعديل) زر العودة هنا بيرجع للنتائج، مش للرئيسية -->
      <button class="back-btn" id="back-to-results">← العودة للنتائج</button>
      <div id="review-content">
        <!-- Review content will be rendered here by JS -->
      </div>
      <button class="start-btn go-back">العودة للرئيسية</button>
    </div>

    <div class="footer">
      <p>Created by Zyad & Yusuf</p>
    </div>
  </div>


  <!-- =============================== -->
  <!--        جزء الـ JavaScript        -->
  <!-- =============================== -->
  
  <!-- (تعديل!) 1. تحميل ملف الأسئلة أولاً -->
  <script src="questions.js"></script>
  
  <!-- (تعديل!) 2. تشغيل السكريبت الرئيسي -->
  <script>
    // --- (ملاحظة) ---
    // تم حذف 'const quizData = { ... }' من هنا
    // لأنه أصبح موجوداً في 'questions.js'
    // --- (ملاحظة) ---

    // --- Global State ---
    let currentQuiz = [];
    let currentQuestionIndex = 0;
    let userAnswers = []; // Store answers {qIndex: 0, answer: 1, isCorrect: true}
    let quizTitle = "";

    /**
     * Shuffles an array in place.
     */
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /**
     * Handles switching tabs.
     */
    function openTab(tabName) {
      document.querySelectorAll(".tab-content").forEach(content => {
        content.classList.remove("active");
      });
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.remove("active");
      });

      const tabToShow = document.getElementById(tabName);
      if(tabToShow) {
        tabToShow.classList.add("active");
      }
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if (activeBtn) {
        activeBtn.classList.add("active");
      }
    }

    /**
     * Starts a selected quiz.
     */
    function startQuiz(bank, quizId) {
      // (مهم!) نتأكد أن 'quizData' اتحمل من الملف الخارجي
      if (typeof quizData === 'undefined') {
          console.error("ملف 'questions.js' لم يُحمل أو يحتوي على خطأ.");
          alert("خطأ في تحميل الأسئلة. حاول تحديث الصفحة.");
          return;
      }
        
      if (!quizData[bank] || !quizData[bank][quizId] || !quizData[bank][quizId].questions) {
          console.error("Quiz not found or empty!", bank, quizId);
          const tabToShow = document.getElementById(bank);
          if(tabToShow) {
            // نمسح أي كروت قديمة ونضع رسالة "قريباً"
            tabToShow.innerHTML = '<p class="coming-soon">الأسئلة قادمة قريباً...</p>';
          }
          openTab(bank); // نفتح التاب عشان المستخدم يشوف الرسالة
          return;
      }
        
      const quiz = quizData[bank][quizId];
      currentQuiz = shuffleArray([...quiz.questions]);
      quizTitle = quiz.title;
      currentQuestionIndex = 0;
      userAnswers = new Array(currentQuiz.length).fill(null); 

      document.getElementById("current-quiz-title").textContent = quizTitle;
      document.getElementById("quiz-selection").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      document.getElementById("results").style.display = "none";
      document.getElementById("review-container").style.display = "none";

      displayQuestion();
      updateNavigation();
    }
    
    /**
     * يعرض السؤال الحالي بالـ HTML المتوافق مع الثيم الجديد
     */
    function displayQuestion() {
      if (currentQuestionIndex >= currentQuiz.length) {
        showResults();
        return;
      }

      const questionData = currentQuiz[currentQuestionIndex];
      const questionContainer = document.getElementById("question-container");
      const userAnswer = userAnswers[currentQuestionIndex];

      let optionsHTML = '';
      
      if (questionData.type === "mcq") {
        optionsHTML = '<div class="answer-options">';
        optionsHTML += questionData.options.map((option, index) => {
          let btnClass = "answer-btn";
          if (userAnswer !== null && userAnswer.answer === index) {
            btnClass += " selected";
          }
          return `<button class="${btnClass}" data-option-index="${index}">${option}</button>`;
        }).join('');
         optionsHTML += '</div>';
      } else if (questionData.type === "tf") {
        optionsHTML = '<div class="tf-options">'; // Use the specific TF wrapper
        optionsHTML += `
          <button class="answer-btn ${userAnswer !== null && userAnswer.answer === true ? 'selected' : ''}" data-tf-value="true">
            صح
          </button>
          <button class="answer-btn ${userAnswer !== null && userAnswer.answer === false ? 'selected' : ''}" data-tf-value="false">
            خطأ
          </button>
        `;
         optionsHTML += '</div>';
      }
     
      questionContainer.innerHTML = `
            <div class="question-card">
              <div class="question-number">السؤال ${currentQuestionIndex + 1}</div>
              <div class="question-text">${questionData.q}</div>
              ${optionsHTML}
            </div>
        `;

      attachQuestionListeners();
      updateProgressBar();
    }
    
    /**
     * يربط المستمعين لأزرار الإجابات
     */
    function attachQuestionListeners() {
        document.querySelectorAll('.answer-btn').forEach(btn => {
            if (btn.dataset.optionIndex) {
                 btn.addEventListener('click', () => {
                    selectOption(parseInt(btn.dataset.optionIndex, 10));
                });
            } else if (btn.dataset.tfValue) {
                btn.addEventListener('click', () => {
                    selectTF(btn.dataset.tfValue === 'true');
                });
            }
        });
    }


    /**
     * Updates the visual progress bar and question counter.
     */
    function updateProgressBar() {
      const progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
      document.getElementById("progress-fill").style.width = `${progress}%`;
      document.getElementById("question-counter").textContent = `السؤال ${currentQuestionIndex + 1} من ${currentQuiz.length}`;
    }

    /**
     * Returns the user to the main quiz selection screen.
     */
    function goBack() {
      document.getElementById("quiz-container").style.display = "none";
      document.getElementById("results").style.display = "none";
      document.getElementById("review-container").style.display = "none";
      document.getElementById("quiz-selection").style.display = "block"; 
      
      const activeTabBtn = document.querySelector('.tab-btn.active');
      const tabId = activeTabBtn ? activeTabBtn.dataset.tab : 'microbiology';
      openTab(tabId);
    }
    
    /**
     * (جديد) وظيفة للرجوع من شاشة المراجعة إلى شاشة النتائج
     */
    function showResultsScreen() {
        document.getElementById("review-container").style.display = "none";
        document.getElementById("results").style.display = "block";
    }


    /**
     * منطق اختيار الإجابة (MCQ) - يخزن الإجابة ويعيد العرض
     */
    function selectOption(optionIndex) {
      const question = currentQuiz[currentQuestionIndex];
      userAnswers[currentQuestionIndex] = {
        answer: optionIndex,
        isCorrect: (optionIndex === question.a)
      };
      displayQuestion(); // Just re-render to show the "selected" class
    }

    /**
     * منطق اختيار الإجابة (TF) - يخزن الإجابة ويعيد العرض
     */
    function selectTF(isTrue) {
      const question = currentQuiz[currentQuestionIndex];
      userAnswers[currentQuestionIndex] = {
        answer: isTrue,
        isCorrect: (isTrue === question.a)
      };
      displayQuestion(); // Just re-render to show the "selected" class
    }

    /**
     * Enables or disables the Next/Prev navigation buttons.
     */
    function updateNavigation() {
      document.getElementById("prev-btn").disabled = (currentQuestionIndex === 0);
      if (currentQuestionIndex === currentQuiz.length - 1) {
        document.getElementById("next-btn").textContent = "إنهاء الاختبار";
      } else {
        document.getElementById("next-btn").textContent = "التالي";
      }
    }

    /**
     * Moves to the next question or finishes the quiz.
     */
    function nextQuestion() {
      if (userAnswers[currentQuestionIndex] == null) {
          // (اختياري) يمكنك إلغاء التعليق عن هذا السطر لإجبار المستخدم على الإجابة
          // console.log("الرجاء اختيار إجابة أولاً");
          // return;
      }
        
      if (currentQuestionIndex < currentQuiz.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      } else {
        showResults();
      }
      updateNavigation();
    }

    /**
     * Moves to the previous question.
     */
    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
      updateNavigation();
    }

    /**
     * Calculates and displays the final score.
     */
    function showResults() {
      let score = 0;
      userAnswers.forEach(answer => {
        if (answer && answer.isCorrect) {
          score++;
        }
      });

      const total = currentQuiz.length;
      const percentage = (score / total) * 100;
      const scoreEl = document.getElementById("final-score");
      const messageEl = document.getElementById("score-message");

      scoreEl.textContent = `${score} / ${total}`;
      
      let message = "نتيجة جيدة!";
      if (percentage >= 90) {
        message = "ممتاز! أحسنت.";
      } else if (percentage >= 75) {
        message = "جيد جداً، استمر.";
      } else if (percentage < 50) {
        message = "تحتاج للمزيد من المراجعة. بالتوفيق المرة القادمة!";
      }
      messageEl.textContent = message;

      document.getElementById("quiz-container").style.display = "none";
      document.getElementById("review-container").style.display = "none";
      document.getElementById("results").style.display = "block";
    }

    /**
     * يعرض المراجعة بالـ HTML المتوافق مع الثيم الجديد
     */
    function showReview() {
      const reviewContent = document.getElementById("review-content");
      reviewContent.innerHTML = ""; 

      currentQuiz.forEach((question, index) => {
        const userAnswer = userAnswers[index];
        const correctAnswer = question.a;
        const isCorrect = userAnswer ? userAnswer.isCorrect : false;

        let optionsReviewHtml = '';
        
        if (question.type === "mcq") {
          optionsReviewHtml = question.options.map((option, i) => {
            let className = 'review-option';
            if (i === correctAnswer) {
              className += ' correct';
            } else if (userAnswer && i === userAnswer.answer && !isCorrect) {
              className += ' user-incorrect';
            }
            return `<div class="${className}">${option}</div>`;
          }).join('');
        } else if (question.type === "tf") {
          optionsReviewHtml = `
            <div class="review-option ${correctAnswer === true ? 'correct' : ''} ${userAnswer && userAnswer.answer === true && !isCorrect ? 'user-incorrect' : ''}">
              صح
            </div>
            <div class="review-option ${correctAnswer === false ? 'correct' : ''} ${userAnswer && userAnswer.answer === false && !isCorrect ? 'user-incorrect' : ''}">
              خطأ
            </div>
          `;
        }

        reviewContent.innerHTML += `
            <div class="review-question">
              <div class="question-number">السؤال ${index + 1}</div>
              <div class="question-text">${question.q}</div>
              ${optionsReviewHtml}
            </div>
        `;
      });

      document.getElementById("results").style.display = "none";
      document.getElementById("review-container").style.display = "block";
    }

    /**
     * (البرمجة الوظيفية) يربط كل المستمعين عند تحميل الصفحة
     */
    function initializeEventListeners() {
      console.log("Initializing event listeners...");
      // 1. Tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          openTab(btn.dataset.tab);
        });
      });

      // 2. Quiz cards
      document.querySelectorAll('.quiz-card').forEach(card => {
        card.addEventListener('click', () => {
          startQuiz(card.dataset.bank, card.dataset.quiz);
        });
      });
      
      // 3. Navigation buttons
      document.getElementById('prev-btn').addEventListener('click', prevQuestion);
      document.getElementById('next-btn').addEventListener('click', nextQuestion);
      document.getElementById('review-btn').addEventListener('click', showReview);
      
      // 4. (جديد) زر العودة من المراجعة للنتائج
       document.getElementById('back-to-results').addEventListener('click', showResultsScreen);


      // 5. All "Go Back" (to main menu) buttons
      document.querySelectorAll('.go-back').forEach(btn => {
        btn.addEventListener('click', goBack);
      });
      console.log("Event listeners initialized.");
    }

    // --- Initial Load ---
    document.addEventListener("DOMContentLoaded", () => {
        // (تعديل) هذا الكود أصبح يتحقق من الأقسام التي لا تحتوي على كروت مضافة يدوياً
        document.querySelectorAll('.tab-content').forEach(tab => {
            // (تعديل) .children.length > 1 لتجاهل رسالة "قريباً"
            if(tab.children.length > 1 || tab.children[0]?.classList.contains('quiz-card')) {
                // هذا التاب يحتوي على كروت، لا تفعل شيئاً
            } else if (tab.children.length === 1 && tab.children[0]?.classList.contains('coming-soon')) {
                // هذا التاب يحتوي فقط على رسالة "قريباً"، اتركه كما هو
            } else {
                // هذا التاب فارغ تماماً (مثل fundamental و biochemistry في الكود الأصلي)
                tab.innerHTML = '<p class="coming-soon">الأسئلة قادمة قريباً...</p>';
            }
        });
        
        openTab('microbiology'); // افتح التبويب الافتراضي
        initializeEventListeners(); // اربط كل الأزرار
    });
  </script>

</body>
</html>

